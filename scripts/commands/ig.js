const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

module.exports.config = {
  name: "profile",
  version: "1.0.4",
  permission: 0,
  credits: "King_Shourov",
  description: "Show user profile pic with sad captions",
  prefix: true,
  category: "user",
  usages: "",
  cooldowns: 5
};

module.exports.run = async ({ api, event }) => {
  const uid = event.senderID;

  // Sad captions list
  const captions = [
    "тЭЭ ржЖржорж┐ рждрзЛржорж╛ржХрзЗ ржнрж╛рж▓рзЛржмрж╛рж╕рждрж╛ржотАж ржХрж┐ржирзНрждрзБ рждрзБржорж┐ рждрзЛ ржмрзБржЭрзЛржирж┐ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рж╣ржарж╛рзО ржХрж░рзЗ ржжрзВрж░рзЗ рж╕рж░рзЗ ржпрж╛ржмрзЛ ржПржХржжрж┐ржи, рждржЦржи ржЦрзБржБржЬрзЗ ржкрж╛ржмрзЗтАж тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржнрж╛ржЩрж╛ ржоржи ржЖрж░ ржнрж╛ржЩрж╛ ржмрж┐рж╢рзНржмрж╛рж╕ ржХрзЛржирзЛржжрж┐ржи ржЬрзЛрзЬрж╛ рж▓рж╛ржЧрзЗ ржирж╛тАж тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржжрзБржГржЦ ржжрж┐рж▓рзЗ ржоржи ржжрж┐рж▓рзЗ ржирж╛ ржирж┐ржЦрзБржБрждржнрж╛ржмрзЗ ржХрж╛ржжрж┐рзЯрзЗ ржмрж▓рзНрж▓рзЗ ржЖрж░ ржХрзЗржжрзЛ ржирж╛ ЁЯШФЁЯШФЁЯШФЁЯШФ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ Think before you say bad things тАФ ржнрж╛рж▓рзЛржмрзЗрж╕рзЗ ржлрзЗрж▓ржмрзЗ тШ║я╕ПЁЯМ╕ЁЯМ╗ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржЖржорж╛рж░ ржорждрзЛ ржЦрж╛рж░рж╛ржк ржЫрзЗрж▓рзЗ, ржПржЗ ржкрзГржерж┐ржмрзАрждрзЗ ржЖрж░ ржПржХржЯрж╛ржУ ржирж╛ржЗтАж ЁЯШЕтЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рж╕рзЗ ржмрж▓рзЗржЫрж┐рж▓рзЛ ржХрзЛржирзЛ ржжрж┐ржирзЛ рж╕рзЗрж░рзЗ ржпрж╛ржмрзЗ ржирж╛тАж рждрж╛рж╣рж▓рзЗ ржЪрж▓рзЗ ржЧрзЗржЫрзЗ ржХрзЗржи? тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржкрзНрж░ржпрж╝рзЛржЬржи ржЫрж╛ржбрж╝рж╛ ржХрзЗржЙ ржЦрзЛржБржЬ ржирзЗрзЯ ржирж╛тАж ржЪрзЗржирж╛ ржорж╛ржирзБрж╖ ржЧрзБрж▓рзЛ ржЕржЪрзЗржирж╛ рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ рж░рзЛржЬ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рждрзБржорж┐ ржЧрж▓рзНржк рж╣ржпрж╝рзЗржУ ржЧрж▓рзНржк ржирж╛, рждрзБржорж┐ рж╕рждрзНржпрж┐ рж╣ржпрж╝рзЗржУ ржХрж▓рзНржкржирж╛ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржкрж░рж┐рж╕рзНржерж┐рждрж┐рж░ ржХрж╛рж░ржгрзЗ ржЪрзБржк рж╣ржпрж╝рзЗ ржЧрзЗржЫрж┐тАж ржирж╛рж╣рж▓рзЗ рж╣рж╛рж╕рж┐ ржЦрзБрж╢рж┐ рждрзЛ ржЖржорж┐ржУ ржХржо ржЫрж┐рж▓рж╛ржо ржирж╛! тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рж╣рж╛рж╕рж┐рж░ ржЙрждрзНрждрж░рзЗ рж╣рж╛рж╕рж┐ ржжрзЗржУрзЯрж╛ ржорж╛ржирзБрж╖ ржЧрзБрж▓рзЛ ржЕрж╕ржорзНржнржм рж╕рзБржирзНржжрж░ ЁЯЩВЁЯШК тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржХрзЛржирзЛ ржПржХ ржорж╛рзЯрж╛ржмрждрзАрж░ ржЬржирзНржп ржЖржЬржУ ржнрж┐рждрж░ржЯрж╛ ржкрзБрзЬрзЗтАж ЁЯдНЁЯк╜ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ Life Is Beautiful If You DonтАЩt Fall In Love тЭЮ тЩбя╕О _ржЬрзАржмржи рж╕рзБржирзНржжрж░ ржпржжрж┐ ржХрж╛рж░рзЛ ржорж╛рзЯрж╛рзЯ ржирж╛ ржкрзЬрзЛ ЁЯЩВЁЯТФ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржЬрзАржмржиржЯрж╛ рждржЦржиржЗ рж╕рзБржирзНржжрж░ ржЫрж┐рж▓, ржпржЦржи ржнрж╛ржмрждрж╛ржо ржЖржХрж╛рж╢рзЗрж░ ржЪрж╛ржБржжржЯрж╛ рж╢рзБржзрзБ ржЖржорж╛рж░ рж╕рж╛ржерзЗржЗ рж╣рж╛ржБржЯрзЗтАж ЁЯСЙтЭдя╕ПтАНЁЯй╣ЁЯеА тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржЪрзЛржЦрзЗрж░ ржкрж╛ржирж┐ ржХржЦржирзЛ ржХрж╛ржЙржХрзЗ ржжрзЗржЦрж╛ржЗ ржирж╛, рж╢рзБржзрзБ ржмрж╛рж▓рж┐рж╢ ржЬрж╛ржирзЗ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржнрзЗрждрж░рзЗ ржХрж╛ржБржжржЫрж┐, ржорзБржЦрзЗ рж╣рзЗрж╕рзЗ ржпрж╛ржЪрзНржЫрж┐тАж ржПржЗ ржЕржнрж┐ржирзЯржЯрж╛ржЗ ржПржЦржи ржЬрзАржмржи тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рждрзЛржорж╛рж░ ржорждрзЛ ржХрж░рзЗ ржнрж╛рж▓рзЛржмрж╛рж╕рждрзЗ ржкрж╛рж░рж┐ржирж┐тАж рждрж╛ржЗ рж╣рж╛рж░рж┐рзЯрзЗ ржЧрзЗрж▓рж╛ржо тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рж╕ржорзНржкрж░рзНржХ ржЖрж░ ржлрж╛ржЗрж▓тАж ржарж┐ржХржорждрзЛ рж╕рзЗржн ржирж╛ ржХрж░рж▓рзЗ ржПржХржжрж┐ржи рж╣рж╛рж░рж┐рзЯрзЗ ржпрж╛рзЯ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ рждрзЛрж░ рж╣рзЗрж╕рзЗ ржЙржарж╛рж░ ржорж╛ржЭрзЗ ржЖржЬ ржЖржорж╛рж░ ржХрж╛ржирзНржирж╛ ржЦрзБржБржЬрзЗ ржкрж╛ржЗ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржпрж╛рж░ рж╣рзГржжржпрж╝ ржнрж╛ржЩрзЗ, рж╕рзЗ ржЪрзБржкржЪрж╛ржк ржерж╛ржХрж▓рзЗржУ ржнрж┐рждрж░рзЗ ржнрж┐рждрж░рзЗ ржХрж╛ржБржжрзЗ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржЖржорж┐ рждрзЛ рж╢рзБржзрзБ рждрзЛржХрзЗ ржнрж╛рж▓рзЛржмрзЗрж╕рзЗржЫрж┐рж▓рж╛ржотАж ржХрж┐ржирзНрждрзБ рждрзБржЗ рждрзЛ ржнрж╛рж▓рзЛржмрж╛рж╕рж╛ ржмрзЛржЭрзЛрж╕ ржирж╛ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн",
    "тЭЭ ржХрж╛рж░рзЛ ржЬржирзНржп ржирж┐ржЬрзЗржХрзЗ ржПрждржЯрж╛ржУ ржмржжрж▓рж┐ржУ ржирж╛тАж ржпрзЗ ржирж┐ржЬрзЗржЗ рждрзЛржХрзЗ ржмрзБржЭрзЗ ржирж╛ тЭЮ тАУ ЁЯТФ BOT OWNER рж╕рзМрж░ржн"
  ];

  const caption = captions[Math.floor(Math.random() * captions.length)];
  const fallbackURL = "https://i.postimg.cc/tTP6nKQv/user404.jpg"; // fallback pic for unfriended users
  const imgURL = `https://graph.facebook.com/${uid}/picture?width=720&height=720`;
  const imgPath = path.join(__dirname, "cache", `${uid}.jpg`);

  let name = "ЁЯШ╢ Unknown";

  try {
    const info = await api.getUserInfo(uid);
    name = info[uid]?.name || name;
  } catch {}

  try {
    const response = await axios({
      url: imgURL,
      method: "GET",
      responseType: "stream",
      validateStatus: false
    });

    const writer = fs.createWriteStream(imgPath);
    if (response.status === 200) {
      response.data.pipe(writer);
      writer.on("finish", () => sendImage(imgPath));
    } else {
      // Use fallback image
      const fallbackPath = path.join(__dirname, "cache", `fallback_${uid}.jpg`);
      const fallbackRes = await axios({ url: fallbackURL, method: "GET", responseType: "stream" });
      const fallbackWriter = fs.createWriteStream(fallbackPath);
      fallbackRes.data.pipe(fallbackWriter);
      fallbackWriter.on("finish", () => sendImage(fallbackPath));
    }

    function sendImage(pathToSend) {
      api.sendMessage({
        body: `ЁЯЦд ЁЭС║ЁЭТВЁЭТЕ ЁЭС┤ЁЭТРЁЭТОЁЭТЖЁЭТПЁЭТХ:\nтЭЭ ${caption} тЭЮ\n\nЁЯСд Name: ${name}\nЁЯФЧ UID: ${uid}`,
        attachment: fs.createReadStream(pathToSend)
      }, event.threadID, () => fs.unlink(pathToSend).catch(() => {}));
    }

  } catch (err) {
    console.error("тЪая╕П Error:", err);
    api.sendMessage("тЭМ ржкрзНрж░рзЛржлрж╛ржЗрж▓ рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред", event.threadID);
  }
};
